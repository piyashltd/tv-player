import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Play, Info, ChevronLeft, ChevronRight, Search, X, Calendar, ArrowLeft, Moon, Sun, RefreshCw, WifiOff } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';

// --- CONFIGURATION ---
const M3U_URL = 'https://github.com/piyashltd/m3ubot/raw/refs/heads/main/serial.m3u';

// --- UTILITY FUNCTIONS ---

// তারিখ ফরম্যাট করার ফাংশন (2025-11-20 -> 20 Nov 2025)
const formatDate = (dateString) => {
  if (!dateString) return '';
  try {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return dateString; // যদি তারিখ সঠিক না হয়, যা আছে তাই রিটার্ন করবে
    return new Intl.DateTimeFormat('en-GB', {
      day: 'numeric',
      month: 'short',
      year: 'numeric',
    }).format(date);
  } catch (e) {
    return dateString;
  }
};

// M3U Parser
const parseM3U = async (url) => {
  try {
    const response = await fetch(url);
    if (!response.ok) throw new Error('Network response was not ok');
    const text = await response.text();
    const lines = text.split('\n');
    const playlist = [];

    let currentItem = {};

    for (let line of lines) {
      line = line.trim();
      if (!line) continue;

      if (line.startsWith('#EXTINF:')) {
        // মেটাডাটা এক্সট্রাকশন
        const groupMatch = line.match(/group-title="([^"]*)"/);
        const logoMatch = line.match(/tvg-logo="([^"]*)"/);
        const titlePart = line.split(',')[1] || '';
        
        // টাইটেল থেকে তারিখ বের করা (Regex: YYYY-MM-DD)
        const dateMatch = titlePart.match(/(\d{4}-\d{2}-\d{2})/);
        const rawDate = dateMatch ? dateMatch[1] : null;
        
        // এপিসোড নম্বর বের করা
        const epMatch = titlePart.match(/Episode\s+(\d+)/i) || titlePart.match(/Ep\s+(\d+)/i);
        const episodeNumber = epMatch ? parseInt(epMatch[1], 10) : 0;

        currentItem = {
          id: Math.random().toString(36).substr(2, 9),
          title: titlePart.trim(),
          group: groupMatch ? groupMatch[1] : 'Others',
          thumb: logoMatch ? logoMatch[1] : null,
          rawDate: rawDate,
          formattedDate: rawDate ? formatDate(rawDate) : '',
          episodeNumber: episodeNumber,
        };
      } else if (!line.startsWith('#')) {
        // স্ট্রিম ইউআরএল চেকিং
        if (currentItem.title && line.startsWith('http')) {
          currentItem.streamUrl = line;
          playlist.push(currentItem);
          currentItem = {}; // রিসেট
        }
      }
    }
    return playlist;
  } catch (error) {
    console.error("Error parsing M3U:", error);
    return [];
  }
};

// --- COMPONENTS ---

// 1. Navbar
const Navbar = ({ onSearch, searchTerm, goHome, isDark, toggleTheme }) => (
  <nav className={`fixed top-0 w-full z-50 px-4 py-3 transition-all duration-300 ${isDark ? 'bg-gradient-to-b from-black/90 to-transparent text-white' : 'bg-white/90 shadow-md text-gray-900 backdrop-blur-sm'}`}>
    <div className="max-w-[1800px] mx-auto flex items-center justify-between">
      <div className="flex items-center gap-8">
        <div 
          onClick={goHome}
          className="text-red-600 font-black text-2xl tracking-tighter cursor-pointer select-none flex items-center gap-1"
        >
          BONGO<span className={isDark ? 'text-white' : 'text-slate-800'}>STREAM</span>
        </div>
        <div className={`hidden md:flex gap-6 text-sm font-medium ${isDark ? 'text-gray-300' : 'text-gray-600'}`}>
          <button onClick={goHome} className="hover:text-red-600 transition-colors">Home</button>
          <button className="hover:text-red-600 transition-colors">Series</button>
        </div>
      </div>

      <div className="flex items-center gap-4">
        <div className={`flex items-center border rounded-full px-3 py-1.5 transition-all duration-300 ${isDark ? 'bg-black/40 border-white/10' : 'bg-gray-100 border-gray-300'} ${searchTerm ? 'w-48 md:w-64' : 'w-10 md:w-64'}`}>
          <Search className={`w-4 h-4 ${isDark ? 'text-gray-300' : 'text-gray-500'}`} />
          <input
            type="text"
            placeholder="Search..."
            className={`bg-transparent border-none outline-none text-sm ml-2 w-full ${isDark ? 'text-white placeholder-gray-500' : 'text-gray-800 placeholder-gray-500'} ${!searchTerm && 'hidden md:block'}`}
            value={searchTerm}
            onChange={(e) => onSearch(e.target.value)}
          />
          {searchTerm && (
            <button onClick={() => onSearch('')}>
              <X className={`w-3 h-3 ${isDark ? 'text-gray-400' : 'text-gray-500'}`} />
            </button>
          )}
        </div>

        <button 
          onClick={toggleTheme}
          className={`p-2 rounded-full transition-all ${isDark ? 'bg-gray-800 text-yellow-400 hover:bg-gray-700' : 'bg-gray-200 text-slate-900 hover:bg-gray-300'}`}
        >
          {isDark ? <Sun className="w-5 h-5" /> : <Moon className="w-5 h-5" />}
        </button>
      </div>
    </div>
  </nav>
);

// 2. Hero Banner
const HeroBanner = ({ featured, onPlay, isDark }) => {
  if (!featured) return null;

  return (
    <div className="relative h-[55vh] md:h-[75vh] w-full overflow-hidden">
      <div className="absolute inset-0">
         <img 
            src={featured.thumb || "https://via.placeholder.com/1920x1080/1a1a1a/ffffff?text=No+Preview"} 
            className="w-full h-full object-cover opacity-60 scale-105 animate-slow-zoom"
            alt="Hero"
            onError={(e) => { e.target.src = 'https://via.placeholder.com/1920x1080/0f172a/ffffff?text=BongoStream'; }}
         />
         <div className={`absolute inset-0 bg-gradient-to-r ${isDark ? 'from-slate-950 via-slate-950/60' : 'from-gray-50 via-gray-50/60'} to-transparent`} />
         <div className={`absolute inset-0 bg-gradient-to-t ${isDark ? 'from-slate-950' : 'from-gray-50'} via-transparent to-transparent`} />
      </div>

      <div className="absolute bottom-0 left-0 w-full p-6 md:p-16 pb-16 z-10 flex flex-col items-start max-w-3xl">
        <motion.div 
          initial={{ opacity: 0, y: 20 }} 
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.8 }}
        >
          <span className="px-2 py-1 bg-red-600 text-white text-xs font-bold uppercase tracking-wider rounded-sm mb-3 inline-block shadow-lg">
            Latest Upload
          </span>
          <h1 className={`text-4xl md:text-6xl font-black leading-tight mb-2 drop-shadow-xl ${isDark ? 'text-white' : 'text-slate-900'}`}>
            {featured.group}
          </h1>
          <h2 className={`text-xl md:text-2xl font-medium mb-4 ${isDark ? 'text-gray-200' : 'text-gray-700'}`}>
             {featured.formattedDate ? featured.formattedDate : featured.title}
          </h2>
          
          <div className="flex items-center gap-4 mt-6">
            <button 
              onClick={() => onPlay(featured)}
              className={`px-6 py-3 rounded-md font-bold flex items-center gap-2 transition-all shadow-lg hover:scale-105 ${isDark ? 'bg-white text-black hover:bg-gray-200' : 'bg-slate-900 text-white hover:bg-slate-800'}`}
            >
              <Play className="w-5 h-5 fill-current" /> Play Now
            </button>
            <button className={`backdrop-blur-md px-6 py-3 rounded-md font-bold flex items-center gap-2 transition-colors ${isDark ? 'bg-gray-600/40 text-white hover:bg-gray-600/60' : 'bg-white/40 text-slate-900 border border-slate-900/10 hover:bg-white/60'}`}>
              <Info className="w-5 h-5" /> Details
            </button>
          </div>
        </motion.div>
      </div>
    </div>
  );
};

// 3. Video Row
const VideoRow = ({ title, videos, onPlay, isDark }) => {
  const rowRef = useRef(null);

  const scroll = (offset) => {
    if (rowRef.current) {
      rowRef.current.scrollBy({ left: offset, behavior: 'smooth' });
    }
  };

  if (!videos || videos.length === 0) return null;

  return (
    <div className="mb-8 md:mb-12 group relative px-4 md:px-12">
      <h3 className={`text-lg md:text-xl font-bold mb-3 flex items-center gap-2 ${isDark ? 'text-white' : 'text-slate-800'}`}>
        {title} <span className="text-xs font-normal text-gray-500 mt-1">({videos.length})</span>
      </h3>
      
      <div className="relative">
        {/* Desktop Left Scroll Button */}
        <button 
          onClick={() => scroll(-600)}
          className="hidden md:flex absolute left-0 top-0 bottom-0 w-12 z-20 items-center justify-center opacity-0 group-hover:opacity-100 transition-all hover:scale-110"
        >
          <div className={`p-2 rounded-full shadow-lg ${isDark ? 'bg-black/70 text-white' : 'bg-white/90 text-slate-800'}`}>
             <ChevronLeft className="w-6 h-6" />
          </div>
        </button>

        <div 
          ref={rowRef}
          className="flex gap-4 overflow-x-auto pb-4 scrollbar-hide snap-x snap-mandatory px-1"
          style={{ scrollbarWidth: 'none', msOverflowStyle: 'none' }}
        >
          {videos.map((video) => (
            <motion.div
              key={video.id}
              className="flex-none w-[160px] md:w-[240px] snap-start cursor-pointer relative group/card"
              whileHover={{ scale: 1.03 }}
              transition={{ duration: 0.2 }}
              onClick={() => onPlay(video)}
            >
              <div className={`aspect-video rounded-lg overflow-hidden relative shadow-md ${isDark ? 'bg-slate-800' : 'bg-gray-200'}`}>
                <img 
                  src={video.thumb} 
                  alt={video.title}
                  className="w-full h-full object-cover"
                  loading="lazy"
                  onError={(e) => { e.target.src = 'https://via.placeholder.com/640x360/1e293b/ffffff?text=No+Image'; }}
                />
                
                <div className="absolute bottom-0 left-0 w-full h-1 bg-white/20">
                   <div className="h-full bg-red-600 w-[30%]" />
                </div>

                <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover/card:opacity-100 transition-opacity bg-black/20">
                  <div className="bg-red-600 p-3 rounded-full shadow-xl transform scale-0 group-hover/card:scale-100 transition-transform">
                    <Play className="w-5 h-5 text-white fill-white" />
                  </div>
                </div>
              </div>

              <div className="mt-2 px-1">
                <h4 className={`font-semibold text-sm line-clamp-1 ${isDark ? 'text-gray-100' : 'text-slate-800'}`}>
                  {video.group}
                </h4>
                <div className="flex items-center justify-between mt-1">
                   {video.episodeNumber > 0 && (
                     <p className="text-red-600 text-xs font-bold">
                       Ep {video.episodeNumber}
                     </p>
                   )}
                   <p className={`text-xs ml-auto ${isDark ? 'text-gray-400' : 'text-gray-500'}`}>
                    {video.formattedDate}
                   </p>
                </div>
              </div>
            </motion.div>
          ))}
        </div>

        {/* Desktop Right Scroll Button */}
        <button 
          onClick={() => scroll(600)}
          className="hidden md:flex absolute right-0 top-0 bottom-0 w-12 z-20 items-center justify-center opacity-0 group-hover:opacity-100 transition-all hover:scale-110"
        >
          <div className={`p-2 rounded-full shadow-lg ${isDark ? 'bg-black/70 text-white' : 'bg-white/90 text-slate-800'}`}>
             <ChevronRight className="w-6 h-6" />
          </div>
        </button>
      </div>
    </div>
  );
};

// 4. Player Page
const PlayerPage = ({ video, allVideos, onBack, onPlayNew, isDark }) => {
  const related = useMemo(() => {
    return allVideos
      .filter(v => v.group === video.group && v.id !== video.id)
      .sort((a, b) => b.episodeNumber - a.episodeNumber);
  }, [allVideos, video]);

  // Scroll to top when video changes
  useEffect(() => {
    window.scrollTo(0, 0);
  }, [video]);

  return (
    <motion.div 
      initial={{ opacity: 0, x: '100%' }}
      animate={{ opacity: 1, x: 0 }}
      exit={{ opacity: 0, x: '100%' }}
      transition={{ type: "spring", stiffness: 300, damping: 30 }}
      className={`fixed inset-0 z-[100] overflow-y-auto ${isDark ? 'bg-slate-950' : 'bg-gray-50'}`}
    >
      {/* Player Header */}
      <div className={`sticky top-0 w-full px-4 py-3 z-30 flex items-center gap-4 backdrop-blur-md border-b ${isDark ? 'bg-black/80 border-white/10 text-white' : 'bg-white/90 border-gray-200 text-slate-900 shadow-sm'}`}>
        <button 
          onClick={onBack} 
          className={`p-2 rounded-full transition-all ${isDark ? 'bg-white/10 hover:bg-white/20' : 'bg-black/5 hover:bg-black/10'}`}
        >
          <ArrowLeft className="w-6 h-6" />
        </button>
        <div className="flex-1 overflow-hidden">
          <h2 className="font-bold text-lg leading-tight truncate">{video.group}</h2>
          <p className={`text-xs truncate ${isDark ? 'text-gray-400' : 'text-gray-500'}`}>
             {video.formattedDate} {video.episodeNumber ? `• Episode ${video.episodeNumber}` : ''}
          </p>
        </div>
      </div>

      {/* Video Player */}
      <div className="w-full bg-black sticky top-[65px] z-20 shadow-2xl">
        <div className="relative w-full aspect-video">
            <video 
            src={video.streamUrl} 
            controls 
            autoPlay 
            className="w-full h-full"
            poster={video.thumb}
            playsInline
            onError={(e) => console.log("Video Error", e)}
            >
            Your browser does not support the video tag.
            </video>
        </div>
      </div>

      {/* Content Info & Related */}
      <div className="max-w-[1600px] mx-auto px-4 md:px-6 py-6 md:py-8">
        <div className="flex flex-col lg:flex-row gap-8 lg:gap-12">
          
          {/* Left: Metadata */}
          <div className="flex-1">
            <h1 className={`text-2xl md:text-3xl font-bold mb-3 ${isDark ? 'text-white' : 'text-slate-900'}`}>
              {video.title}
            </h1>
            <div className="flex flex-wrap items-center gap-3 text-sm mb-6">
              <span className="text-green-600 font-bold bg-green-100 dark:bg-green-900/30 px-2 py-0.5 rounded text-xs">NEW</span>
              <span className={isDark ? 'text-gray-400' : 'text-gray-600'}>
                {video.rawDate ? video.rawDate.split('-')[0] : '2025'}
              </span>
              <span className={`border px-1 text-xs rounded ${isDark ? 'border-gray-600 text-gray-400' : 'border-gray-400 text-gray-600'}`}>HD</span>
              <span className={`flex items-center gap-1 ${isDark ? 'text-gray-400' : 'text-gray-600'}`}>
                <Calendar className="w-3 h-3"/> {video.formattedDate}
              </span>
            </div>
            
            <div className={`p-4 rounded-lg ${isDark ? 'bg-white/5' : 'bg-gray-100'}`}>
                <p className={`leading-relaxed text-sm md:text-base ${isDark ? 'text-gray-300' : 'text-gray-700'}`}>
                Enjoy the latest episode of <strong>{video.group}</strong>. 
                Streaming in high definition. Published on {video.formattedDate}.
                </p>
            </div>
          </div>

          {/* Right: Up Next */}
          <div className="w-full lg:w-1/3">
             <h3 className={`text-xl font-bold mb-4 sticky top-0 ${isDark ? 'text-white' : 'text-slate-900'}`}>
               More Episodes
             </h3>
             <div className="flex flex-col gap-3">
                {related.slice(0, 15).map(rel => (
                  <div 
                    key={rel.id} 
                    onClick={() => onPlayNew(rel)}
                    className={`flex gap-3 group cursor-pointer p-2 rounded-md transition-colors ${isDark ? 'hover:bg-white/5' : 'hover:bg-black/5'} ${rel.id === video.id ? 'bg-red-500/10' : ''}`}
                  >
                    <div className="relative w-32 aspect-video bg-slate-800 rounded overflow-hidden flex-shrink-0 shadow-sm">
                      <img src={rel.thumb} className="w-full h-full object-cover" alt="" />
                      <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 bg-black/40 transition-opacity">
                        <Play className="w-5 h-5 text-white" />
                      </div>
                    </div>
                    <div className="flex flex-col justify-center min-w-0">
                      <h4 className={`text-sm font-medium line-clamp-2 ${isDark ? 'text-gray-200 group-hover:text-white' : 'text-slate-800 group-hover:text-black'}`}>
                        {rel.formattedDate}
                      </h4>
                      <span className={`text-xs mt-1 truncate ${isDark ? 'text-gray-500' : 'text-gray-500'}`}>
                        {rel.group}
                      </span>
                    </div>
                  </div>
                ))}
                {related.length === 0 && (
                  <div className={`p-4 rounded border border-dashed text-center ${isDark ? 'border-gray-700 text-gray-500' : 'border-gray-300 text-gray-500'}`}>
                    No other episodes found for this series.
                  </div>
                )}
             </div>
          </div>
        </div>
      </div>
    </motion.div>
  );
};

// --- MAIN APP CONTAINER ---

const App = () => {
  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(true);
  const [view, setView] = useState('home'); 
  const [currentVideo, setCurrentVideo] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [isDark, setIsDark] = useState(true);

  // 1. Data Fetching
  const loadData = async () => {
    setLoading(true);
    const parsedData = await parseM3U(M3U_URL);
    setData(parsedData);
    setLoading(false);
  };

  useEffect(() => {
    loadData();
  }, []);

  // 2. Mobile Back Button Handling (History API)
  useEffect(() => {
    const handlePopState = (event) => {
      // যদি ইউজার ব্যাক বাটন চাপে এবং আমরা প্লেয়ার মোডে থাকি
      if (view === 'player') {
        setView('home');
        setCurrentVideo(null);
      }
    };

    window.addEventListener('popstate', handlePopState);
    return () => window.removeEventListener('popstate', handlePopState);
  }, [view]);

  // 3. Navigation Helpers
  const handlePlay = (video) => {
    // ব্রাউজার হিস্ট্রিতে স্টেট পুশ করুন
    window.history.pushState({ videoId: video.id }, '', `#watch`);
    setCurrentVideo(video);
    setView('player');
  };

  const handleBackToHome = () => {
    // ম্যানুয়ালি ব্যাক করলে হিস্ট্রি ঠিক রাখা
    if (view === 'player') {
      window.history.back(); 
      // popstate ইভেন্ট হ্যান্ডলার বাকি কাজ করবে
    } else {
      setView('home');
    }
  };

  const handleGoHome = () => {
    if (view === 'player') {
       window.history.back();
    } else {
       window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  };

  const toggleTheme = () => setIsDark(!isDark);

  // 4. Data Processing (Search, Sort, Group)
  const organizedData = useMemo(() => {
    if (!data.length) return { featured: null, latest: [], grouped: {} };

    const filtered = searchTerm 
      ? data.filter(item => 
          item.title.toLowerCase().includes(searchTerm.toLowerCase()) || 
          item.group.toLowerCase().includes(searchTerm.toLowerCase())
        )
      : data;

    // তারিখ অনুযায়ী সর্টিং (নতুন আগে)
    const latest = [...filtered].sort((a, b) => {
      const dateA = a.rawDate ? new Date(a.rawDate) : new Date(0);
      const dateB = b.rawDate ? new Date(b.rawDate) : new Date(0);
      return dateB - dateA;
    });

    const grouped = {};
    filtered.forEach(item => {
      if (!grouped[item.group]) grouped[item.group] = [];
      grouped[item.group].push(item);
    });

    // গ্রুপের ভেতরের আইটেমগুলোও তারিখ অনুযায়ী সাজানো
    Object.keys(grouped).forEach(key => {
      grouped[key].sort((a, b) => {
         const dateA = a.rawDate ? new Date(a.rawDate) : new Date(0);
         const dateB = b.rawDate ? new Date(b.rawDate) : new Date(0);
         return dateB - dateA;
      });
    });

    return { featured: latest[0], latest, grouped };
  }, [data, searchTerm]);


  // Loading State
  if (loading) {
    return (
      <div className={`min-h-screen flex flex-col items-center justify-center ${isDark ? 'bg-slate-950 text-white' : 'bg-gray-50 text-slate-900'}`}>
        <div className="w-12 h-12 border-4 border-red-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p className="opacity-70 animate-pulse text-sm">Connecting to Server...</p>
      </div>
    );
  }

  // Error/Empty State
  if (!loading && data.length === 0) {
     return (
        <div className={`min-h-screen flex flex-col items-center justify-center p-6 text-center ${isDark ? 'bg-slate-950 text-white' : 'bg-gray-50 text-slate-900'}`}>
           <WifiOff className="w-16 h-16 text-gray-500 mb-4" />
           <h2 className="text-2xl font-bold mb-2">Connection Failed</h2>
           <p className="text-gray-500 mb-6 max-w-md">Could not load the playlist. Check your internet connection or the M3U URL.</p>
           <button 
             onClick={loadData}
             className="px-6 py-2 bg-red-600 text-white rounded-full flex items-center gap-2 hover:bg-red-700 transition-colors"
           >
             <RefreshCw className="w-4 h-4" /> Retry
           </button>
        </div>
     );
  }

  return (
    <div className={`min-h-screen font-sans transition-colors duration-300 selection:bg-red-600 selection:text-white ${isDark ? 'bg-slate-950 text-white' : 'bg-gray-50 text-slate-900'}`}>
      <Navbar 
        searchTerm={searchTerm} 
        onSearch={setSearchTerm} 
        goHome={handleGoHome}
        isDark={isDark}
        toggleTheme={toggleTheme}
      />

      <AnimatePresence mode="wait">
        {view === 'home' && (
          <motion.div
            key="home"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="pb-20"
          >
            {/* Only show Hero if not searching */}
            {!searchTerm && (
              <HeroBanner 
                featured={organizedData.featured} 
                onPlay={handlePlay} 
                isDark={isDark}
              />
            )}
            
            <div className={`relative z-20 ${!searchTerm ? '-mt-20 md:-mt-32' : 'mt-24'}`}>
              
              <VideoRow 
                title={searchTerm ? "Search Results" : "Latest Episodes"} 
                videos={organizedData.latest.slice(0, 15)} 
                onPlay={handlePlay}
                isDark={isDark}
              />

              {!searchTerm && Object.entries(organizedData.grouped).map(([groupName, videos]) => (
                <VideoRow 
                  key={groupName} 
                  title={groupName} 
                  videos={videos} 
                  onPlay={handlePlay}
                  isDark={isDark}
                />
              ))}
              
              {searchTerm && organizedData.latest.length === 0 && (
                <div className="text-center py-20 opacity-50 flex flex-col items-center">
                  <Search className="w-12 h-12 mb-4 opacity-50" />
                  <p>No results found for "{searchTerm}"</p>
                </div>
              )}
            </div>
          </motion.div>
        )}

        {view === 'player' && currentVideo && (
          <PlayerPage 
            key="player"
            video={currentVideo} 
            allVideos={data} 
            onBack={handleBackToHome}
            onPlayNew={handlePlay}
            isDark={isDark}
          />
        )}
      </AnimatePresence>
      
      {view === 'home' && (
        <footer className={`py-12 px-4 border-t text-center text-sm transition-colors ${isDark ? 'bg-black border-gray-900 text-gray-600' : 'bg-gray-100 border-gray-200 text-gray-500'}`}>
           <p>&copy; 2025 BongoStream OTT.</p>
        </footer>
      )}
    </div>
  );
};

export default App;
